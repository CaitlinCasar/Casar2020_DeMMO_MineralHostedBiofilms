##combine pasta files into one file
qiime@qiime-190-virtual-box:/media/sf_share/DeMMO_Dec2015toApril2018$ cat DeMMO_Dec2015toAug2017.fasta DeMMO_April2018.fna > DeMMO_Dec2015toApril2018.fasta

##filter a subset of samples from the combined file 
qiime@qiime-190-virtual-box:/media/sf_share/DeMMO_Dec2015toApril2018$ filter_fasta.py -f DeMMO_Dec2015toApril2018.fasta --sample_id_fp DeMMO136_Dec2015toApril2018_Map.txt -o DeMMO136_Dec2015toApril2018.fasta

###check that sample names are formatted properly for usearch native 
qiime@qiime-190-virtual-box:~/Desktop/Shared_Folder/DeMMO_Dec2015toApril2018/DeMMO136_Dec2015toApril2018$ usearch -fastx_get_sample_names DeMMO136_Dec2015toApril2018.fasta -sample_delim _ -output DeMMO136_Dec2015toApril2018_samples.txt

##dereplicate sequences 
qiime@qiime-190-virtual-box:~/Desktop/Shared_Folder/DeMMO_Dec2015toApril2018/DeMMO136_Dec2015toApril2018$ usearch -fastx_uniques DeMMO136_Dec2015toApril2018.fasta -fastaout DeMMO136_Dec2015toApril2018_derep.fasta -sizeout

##sort sequences by decreasing size
qiime@qiime-190-virtual-box:~/Desktop/Shared_Folder/DeMMO_Dec2015toApril2018/DeMMO136_Dec2015toApril2018$ usearch -sortbysize DeMMO136_Dec2015toApril2018_derep.fasta -fastaout DeMMO136_Dec2015toApril2018_derep_sorted.fasta

##pick OTU’s
qiime@qiime-190-virtual-box:~/Desktop/Shared_Folder/DeMMO_Dec2015toApril2018/DeMMO136_Dec2015toApril2018$ usearch -cluster_otus DeMMO136_Dec2015toApril2018_derep_sorted.fasta -otus DeMMO136_Dec2015toApril2018_derep_sorted_otus.fasta -relabel OTU_ -uparseout DeMMO136_Dec2015toApril2018_derep_sorted_otus_results.txt -minsize 2

###output###
01:46 81Mb    100.0% 9307 OTUs, 9174 chimeras

##create OTU table
qiime@qiime-190-virtual-box:~/Desktop/Shared_Folder/DeMMO_Dec2015toApril2018/DeMMO136_Dec2015toApril2018$ usearch -usearch_global DeMMO136_Dec2015toApril2018.fasta -sample_delim _ -db DeMMO136_Dec2015toApril2018_derep_sorted_otus.fasta -sample_delim _ -strand plus -id 0.97 -otutabout DeMMO136_Dec2015toApril2018_noChimera.otutable.txt -biomout DeMMO136_Dec2015toApril2018_noChimera_otuTable.biom

##convert OTU table to hdf5 format for Qiime
qiime@qiime-190-virtual-box:~/Desktop/Shared_Folder/DeMMO_Dec2015toApril2018/DeMMO136_Dec2015toApril2018$ biom convert -i DeMMO136_Dec2015toApril2018_noChimera.otutable.txt -o  DeMMO136_Dec2015toApril2018_noChimera_hdf5.biom --table-type="OTU table" --to-hdf5


##Assign taxonomy to OTU’s
assign_taxonomy.py -i DeMMO136_Dec2015toApril2018_derep_sorted_otus.fasta -t ../../Silva132/consensus_taxonomy_7_levels.txt -r ../../Silva132/silva_132_99_16S.fna --similarity 0.9 --uclust_max_accepts 10 --min_consensus_fraction 0.90 -o uclust_taxa_0.9_10_9.0_chimerasRemoved/


##Add taxonomy to OTU table 
biom add-metadata -i DeMMO136_Dec2015toApril2018_noChimera_hdf5.biom -o DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa.biom --observation-metadata-fp uclust_taxa_0.9_10_9.0_chimerasRemoved/DeMMO136_Dec2015toApril2018_derep_sorted_otus_tax_assignments.txt --sc-separated taxonomy --observation-header OTUID,taxonomy

##check add-metadata output
qiime@qiime-190-virtual-box:~/Desktop/Shared_Folder/DeMMO_Dec2015toApril2018/DeMMO136_Dec2015toApril2018$ biom convert -i DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa.biom -o DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa.txt --to-tsv --header-key taxonomy

###Filter out OTUs at < 0.005% abundance
filter_otus_from_otu_table.py -i DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa.biom -o DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa_filtered.biom --min_count_fraction 0.00005

## check OTU table stats
biom summarize-table -i DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa_filtered.biom -o DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa_table_summary.txt

pico DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa_table_summary.txt

###3994 was lowest read count (aside from 251 which is too low), rarefy to this read depth:
single_rarefaction.py -i DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa_filtered.biom -d 3994 -o DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa_filtered_d3994.biom 

##sort OTU table by sample category 
sort_otu_table.py -i DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa_filtered_d3994.biom -l DeMMO136_Dec2015toApril2018_Map_categorized.txt -o DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa_filtered_d3994_categorized.biom

##summarize taxa absolute abundances at all taxonomic levels
summarize_taxa.py -i DeMMO136_Dec2015toApril2018_noChimera_otuTable_withTaxa_filtered_d3994_categorized.biom -a -o DeMMO136_Dec2015toApril2018_noChimera_d3994_categorized_abs_summary/ -L 1,2,3,4,5,6,7 --suppress_biom_table_output



